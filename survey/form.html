<script type="module">
	/* ---------- Configuration ---------- */
	const CSV_URL = 'questions.csv';
	const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xrbyjror';

	/* ---------- Util ---------- */
	function rng(seed) {
		let t = seed >>> 0;
		return () => {
			t |= 0;
			t = (t + 0x6d2b79f5) | 0;
			let r = Math.imul(t ^ (t >>> 15), 1 | t);
			r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
			return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
		};
	}
	function shuffle(a, rand = Math.random) {
		const x = a.slice();
		for (let i = x.length - 1; i > 0; i--) {
			const j = Math.floor(rand() * (i + 1));
			[x[i], x[j]] = [x[j], x[i]];
		}
		return x;
	}
	function seedFromCrypto() {
		const b = new Uint32Array(1);
		crypto.getRandomValues(b);
		return b[0];
	}

	/* ---------- Load Papa Parse ---------- */
	await new Promise((ok, err) => {
		const s = document.createElement('script');
		s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
		s.onload = ok;
		s.onerror = err;
		document.head.appendChild(s);
	});

	/* ---------- Load two-option questions ---------- */
	async function loadQuestions() {
		const res = await fetch(CSV_URL, { cache: 'no-store' });
		const text = await res.text();
		const { data } = Papa.parse(text, { header: true, skipEmptyLines: true });
		const questions = [];
		for (const row of data) {
			if (!row || !row.question_id) continue;
			const qid = String(row.question_id).trim();
			const qtext = row.question_text ?? '';
			const o1id = row.option_1_id?.trim();
			const o1lab = row.option_1_label?.trim();
			const o2id = row.option_2_id?.trim();
			const o2lab = row.option_2_label?.trim();
			if (o1id && o2id && o1lab && o2lab)
				questions.push({
					id: qid,
					text: qtext,
					options: [
						{ id: o1id, label: o1lab },
						{ id: o2id, label: o2lab }
					]
				});
		}
		return questions;
	}

	/* ---------- State ---------- */
	const state = {
		seed: seedFromCrypto(),
		email: '',
		consent: false,
		questions: [],
		qOrder: [],
		idx: 0,
		answers: {}
	};

	/* ---------- UI refs ---------- */
	const pageEmail = document.getElementById('page-email');
	const pageQ = document.getElementById('page-q');
	const pageFinish = document.getElementById('page-finish');
	const qTitle = document.getElementById('q-title');
	const progress = document.getElementById('progress');
	const startBtn = document.getElementById('start');
	const consent = document.getElementById('consent');
	const email = document.getElementById('email');
	const nextBtn = document.getElementById('next');
	const prevBtn = document.getElementById('prev');
	const submitBtn = document.getElementById('submit');
	const emailMsg = document.getElementById('email-msg');
	const sendMsg = document.getElementById('send-msg');
	const summary = document.getElementById('summary');
	const pair = document.getElementById('pair');
	const leftBtn = document.getElementById('left');
	const rightBtn = document.getElementById('right');

	function show(el) {
		[pageEmail, pageQ, pageFinish].forEach((p) => p.classList.add('d-none'));
		el.classList.remove('d-none');
	}

	/* ---------- Helpers ---------- */
	function currentQuestion() {
		const qid = state.qOrder[state.idx];
		return state.questions.find((q) => q.id === qid);
	}

	function renderQuestion() {
		const q = currentQuestion();
		qTitle.innerHTML = q.text;
		progress.textContent = `Question ${state.idx + 1} of ${state.qOrder.length}`;
		const [a, b] = shuffle(q.options, rng(state.seed + state.idx));
		leftBtn.textContent = a.label;
		rightBtn.textContent = b.label;
		leftBtn.dataset.choice = a.id;
		rightBtn.dataset.choice = b.id;
		prevBtn.classList.toggle('disabled', state.idx === 0);
		nextBtn.textContent = state.idx === state.qOrder.length - 1 ? 'Proceed to submit' : 'Next';
	}

	function captureCurrent(choiceId) {
		state.answers[state.qOrder[state.idx]] = choiceId;
	}

	/* ---------- Flow ---------- */
	startBtn.addEventListener('click', async () => {
		state.email = email.value.trim();
		state.consent = consent.checked;
		if (!state.consent) {
			emailMsg.textContent = 'Please give consent.';
			return;
		}
		if (state.email && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(state.email)) {
			emailMsg.textContent = 'Invalid email.';
			return;
		}

		state.questions = await loadQuestions();
		state.qOrder = shuffle(
			state.questions.map((q) => q.id),
			rng(state.seed)
		);
		state.idx = 0;
		show(pageQ);
		renderQuestion();
		emailMsg.textContent = '';
	});

	[leftBtn, rightBtn].forEach((btn) => {
		btn.addEventListener('click', () => {
			captureCurrent(btn.dataset.choice);
			if (state.idx < state.qOrder.length - 1) {
				state.idx++;
				renderQuestion();
			} else {
				summary.textContent = `Ready to submit. ${Object.keys(state.answers).length} answers.`;
				show(pageFinish);
			}
		});
	});

	nextBtn.addEventListener('click', () => {
		if (!state.answers[state.qOrder[state.idx]]) {
			alert('Select one.');
			return;
		}
		if (state.idx < state.qOrder.length - 1) {
			state.idx++;
			renderQuestion();
		} else {
			summary.textContent = `Ready to submit. ${Object.keys(state.answers).length} answers.`;
			show(pageFinish);
		}
	});
	prevBtn.addEventListener('click', () => {
		if (state.idx > 0) {
			state.idx--;
			renderQuestion();
		}
	});

	submitBtn.addEventListener('click', async () => {
		if (!state.answers[state.qOrder[state.idx]]) {
			alert('Select one.');
			return;
		}
		const payload = {
			seed: String(state.seed),
			email: state.email || null,
			q_order: state.qOrder,
			answers: state.answers
		};
		sendMsg.textContent = 'Sending…';
		try {
			const r = await fetch(FORMSPREE_ENDPOINT, {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});
			sendMsg.textContent = r.ok ? 'Thanks. Answers saved.' : 'Submit error.';
			if (r.ok) submitBtn.disabled = true;
		} catch (err) {
			sendMsg.textContent = 'Network error: ' + err;
		}
	});
</script>

<div class="container my-4" id="app">
	<!-- Page 1: Email -->
	<div class="card" id="page-email">
		<div class="card-body">
			<h3 class="card-title mb-3">Contact</h3>
			<p class="text-muted">Email for follow-up. Optional.</p>

			<div class="mb-3">
				<label for="email" class="form-label">Email</label>
				<input id="email" type="email" class="form-control" placeholder="name@example.org" />
			</div>

			<div class="form-check mb-3">
				<input class="form-check-input" type="checkbox" id="consent" />
				<label class="form-check-label" for="consent">
					I consent to the processing of my data for this study.
				</label>
			</div>

			<button id="start" class="btn btn-primary">Start</button>
			<p id="email-msg" class="text-muted mt-2"></p>
		</div>
	</div>

	<!-- Page 2: Question -->
	<div class="card d-none" id="page-q">
		<div class="card-body">
			<div id="progress" class="text-muted mb-2"></div>
			<h3 id="q-title" class="card-title mb-2">Question</h3>
			<p class="text-muted">Select the better description.</p>

			<div id="pair" class="d-flex flex-column flex-md-row gap-3 mb-3">
				<button id="left" class="btn btn-outline-secondary flex-fill"></button>
				<button id="right" class="btn btn-outline-secondary flex-fill"></button>
			</div>

			<div class="d-flex gap-2">
				<button id="prev" class="btn btn-outline-secondary">Back</button>
				<button id="next" class="btn btn-primary">Next</button>
			</div>
		</div>
	</div>

	<!-- Page 3: Finish -->
	<div class="card d-none" id="page-finish">
		<div class="card-body">
			<h3 class="card-title mb-3">Finish</h3>
			<p class="text-muted" id="summary">Submitting…</p>
			<button id="submit" class="btn btn-primary">Submit answers</button>
			<div id="send-msg" class="text-muted mt-2"></div>
		</div>
	</div>
</div>

<style>
	/* small UX helper */
	#ranklist .list-group-item {
		cursor: grab;
	}
</style>
