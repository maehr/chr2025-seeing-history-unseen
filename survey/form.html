<script type="module">
	/* ---------- Configuration ---------- */
	const CSV_URL = 'questions.csv'; // sits next to the .qmd
	const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xrbyjror';

	/* ---------- Util: Seed, RNG, Shuffle ---------- */
	function rng(seed) {
		let t = seed >>> 0;
		return () => {
			t |= 0;
			t = (t + 0x6d2b79f5) | 0;
			let r = Math.imul(t ^ (t >>> 15), 1 | t);
			r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
			return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
		};
	}
	function shuffle(a, rand = Math.random) {
		const x = a.slice();
		for (let i = x.length - 1; i > 0; i--) {
			const j = Math.floor(rand() * (i + 1));
			[x[i], x[j]] = [x[j], x[i]];
		}
		return x;
	}
	function seedFromCrypto() {
		const b = new Uint32Array(1);
		crypto.getRandomValues(b);
		return b[0];
	}
	function hashSeed(seed, str) {
		let h = seed ^ 2166136261;
		for (let i = 0; i < str.length; i++) {
			h ^= str.charCodeAt(i);
			h = Math.imul(h, 16777619);
		}
		return h >>> 0;
	}

	/* ---------- Load Papa Parse ---------- */
	await new Promise((ok, err) => {
		const s = document.createElement('script');
		s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
		s.onload = ok;
		s.onerror = err;
		document.head.appendChild(s);
	});

	/* ---------- Data loading (updated for wide CSV) ---------- */
	// Expected headers:
	// question_id,question_text,
	// option_1_id,option_1_label,option_2_id,option_2_label,option_3_id,option_3_label,option_4_id,option_4_label
	async function loadQuestions() {
		const res = await fetch(CSV_URL, { cache: 'no-store' });
		const text = await res.text();
		const { data } = Papa.parse(text, { header: true, skipEmptyLines: true });

		const questions = [];
		for (const row of data) {
			if (!row || row.question_id == null) continue;
			const qid = String(row.question_id).trim();
			const qtext = row.question_text ?? '';

			// Collect option pairs option_i_id / option_i_label
			const options = [];
			// Support up to 50 pairs defensively; adjust as needed.
			for (let i = 1; i <= 50; i++) {
				const oidRaw = row[`option_${i}_id`];
				const olab = row[`option_${i}_label`];
				if (oidRaw == null && olab == null) continue; // skip completely empty pairs
				if (oidRaw == null || olab == null) continue; // skip incomplete pairs
				const oid = String(oidRaw).trim();
				if (!oid || !String(olab).trim()) continue;
				options.push({ id: oid, label: olab });
			}

			// Only keep questions that have at least two options
			if (options.length >= 2) {
				questions.push({ id: qid, text: qtext, options });
			}
		}
		return questions;
	}

	/* ---------- State ---------- */
	const state = {
		seed: seedFromCrypto(),
		email: '',
		consent: false,
		questions: [],
		qOrder: [],
		idx: 0,
		answers: {}
	};

	/* ---------- UI refs ---------- */
	const pageEmail = document.getElementById('page-email');
	const pageQ = document.getElementById('page-q');
	const pageFinish = document.getElementById('page-finish');
	const qTitle = document.getElementById('q-title');
	const ranklist = document.getElementById('ranklist');
	const progress = document.getElementById('progress');
	const startBtn = document.getElementById('start');
	const consent = document.getElementById('consent');
	const email = document.getElementById('email');
	const nextBtn = document.getElementById('next');
	const prevBtn = document.getElementById('prev');
	const submitBtn = document.getElementById('submit');
	const emailMsg = document.getElementById('email-msg');
	const sendMsg = document.getElementById('send-msg');
	const summary = document.getElementById('summary');

	function show(el) {
		[pageEmail, pageQ, pageFinish].forEach((p) => p.classList.add('d-none'));
		el.classList.remove('d-none');
	}

	/* ---------- Drag & Drop ---------- */
	let dragEl = null;
	ranklist.addEventListener('dragstart', (e) => {
		if (e.target.tagName !== 'LI') return;
		dragEl = e.target;
		e.dataTransfer.effectAllowed = 'move';
		dragEl.classList.add('opacity-50');
	});
	ranklist.addEventListener('dragend', () => {
		if (dragEl) {
			dragEl.classList.remove('opacity-50');
			dragEl = null;
		}
	});
	ranklist.addEventListener('dragover', (e) => {
		if (!dragEl) return;
		e.preventDefault();
		const items = [...ranklist.querySelectorAll('li')];
		const after = items.find((li) => {
			const r = li.getBoundingClientRect();
			return e.clientY < r.top + r.height / 2;
		});
		if (after) ranklist.insertBefore(dragEl, after);
		else ranklist.appendChild(dragEl);
	});

	/* ---------- Rendering ---------- */
	function currentQuestion() {
		const qid = state.qOrder[state.idx];
		return state.questions.find((q) => q.id === qid);
	}

	function renderQuestion() {
		const q = currentQuestion();
		qTitle.innerHTML = q.text;
		progress.textContent = `Question ${state.idx + 1} of ${state.qOrder.length}`;
		ranklist.innerHTML = '';

		// Stable shuffled start order per question
		const R = rng(hashSeed(state.seed, q.id));
		const opts = shuffle(q.options, R);
		const startList = state.answers[q.id]?.map((id) => q.options.find((x) => x.id === id)) ?? opts;

		for (const o of startList) {
			const li = document.createElement('li');
			li.className = 'list-group-item';
			li.textContent = o.label;
			li.dataset.choice = o.id;
			li.setAttribute('draggable', 'true');
			ranklist.appendChild(li);
		}
		prevBtn.classList.toggle('disabled', state.idx === 0);
		nextBtn.textContent = state.idx === state.qOrder.length - 1 ? 'Proceed to submit' : 'Next';
	}

	/* ---------- Serialization ---------- */
	function captureCurrent() {
		const q = currentQuestion();
		const order = [...ranklist.querySelectorAll('li')].map((li) => li.dataset.choice);
		if (order.length !== q.options.length) return false;
		state.answers[q.id] = order;
		return true;
	}

	/* ---------- Flow ---------- */
	startBtn.addEventListener('click', async () => {
		state.email = email.value.trim();
		state.consent = consent.checked;
		if (!state.consent) {
			emailMsg.textContent = 'Please give consent.';
			return;
		}
		if (state.email && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(state.email)) {
			emailMsg.textContent = 'Please enter a valid email or leave empty.';
			return;
		}

		state.questions = await loadQuestions();
		const R = rng(state.seed);
		state.qOrder = shuffle(
			state.questions.map((q) => q.id),
			R
		);

		show(pageQ);
		renderQuestion();
		emailMsg.textContent = '';
	});

	nextBtn.addEventListener('click', () => {
		if (!captureCurrent()) {
			alert('Please rank all options.');
			return;
		}
		if (state.idx < state.qOrder.length - 1) {
			state.idx += 1;
			renderQuestion();
		} else {
			summary.textContent = `Ready to submit. ${state.qOrder.length} questions answered.`;
			show(pageFinish);
		}
	});

	prevBtn.addEventListener('click', () => {
		if (state.idx > 0) {
			state.idx -= 1;
			renderQuestion();
		}
	});

	submitBtn.addEventListener('click', async () => {
		if (!captureCurrent()) {
			alert('Please rank all options.');
			return;
		}
		const payload = {
			seed: String(state.seed),
			email: state.email || null,
			q_order: state.qOrder,
			answers: state.answers
		};
		sendMsg.textContent = 'Sending…';
		try {
			const r = await fetch(FORMSPREE_ENDPOINT, {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});
			if (r.ok) {
				sendMsg.textContent = 'Thanks. Answers saved.';
				submitBtn.disabled = true;
			} else {
				const t = await r.text();
				sendMsg.textContent = 'Submit error: ' + t.slice(0, 200);
			}
		} catch (err) {
			sendMsg.textContent = 'Network error: ' + err;
		}
	});
</script>

<div class="container my-4" id="app">
	<!-- Page 1: Email -->
	<div class="card" id="page-email">
		<div class="card-body">
			<h3 class="card-title mb-3">Contact</h3>
			<p class="text-muted">Email for follow-up. Optional.</p>

			<div class="mb-3">
				<label for="email" class="form-label">Email</label>
				<input id="email" type="email" class="form-control" placeholder="name@example.org" />
			</div>

			<div class="form-check mb-3">
				<input class="form-check-input" type="checkbox" id="consent" />
				<label class="form-check-label" for="consent">
					I consent to the processing of my data for this study.
				</label>
			</div>

			<button id="start" class="btn btn-primary">Start</button>
			<p id="email-msg" class="text-muted mt-2"></p>
		</div>
	</div>

	<!-- Page 2: Question -->
	<div class="card d-none" id="page-q">
		<div class="card-body">
			<div id="progress" class="text-muted mb-2"></div>
			<h3 id="q-title" class="card-title mb-2">Question</h3>
			<p class="text-muted">Drag to rank (top = rank 1).</p>

			<ul class="list-group mb-3" id="ranklist"></ul>

			<div class="d-flex gap-2">
				<button id="prev" class="btn btn-outline-secondary">Back</button>
				<button id="next" class="btn btn-primary">Next</button>
			</div>
		</div>
	</div>

	<!-- Page 3: Finish -->
	<div class="card d-none" id="page-finish">
		<div class="card-body">
			<h3 class="card-title mb-3">Finish</h3>
			<p class="text-muted" id="summary">Submitting…</p>
			<button id="submit" class="btn btn-primary">Submit answers</button>
			<div id="send-msg" class="text-muted mt-2"></div>
		</div>
	</div>
</div>

<style>
	/* small UX helper */
	#ranklist .list-group-item {
		cursor: grab;
	}
</style>