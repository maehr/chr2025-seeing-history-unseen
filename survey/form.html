<script type="module">
	/* ---------- Konfiguration ---------- */
	const CSV_URL = 'questions.csv'; // liegt neben dem .qmd
	const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xrbyjror';

	/* ---------- Util: Seed, RNG, Shuffle ---------- */
	function rng(seed) {
		let t = seed >>> 0;
		return () => {
			t |= 0;
			t = (t + 0x6d2b79f5) | 0;
			let r = Math.imul(t ^ (t >>> 15), 1 | t);
			r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
			return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
		};
	}
	function shuffle(a, rand = Math.random) {
		const x = a.slice();
		for (let i = x.length - 1; i > 0; i--) {
			const j = Math.floor(rand() * (i + 1));
			[x[i], x[j]] = [x[j], x[i]];
		}
		return x;
	}
	function seedFromCrypto() {
		const b = new Uint32Array(1);
		crypto.getRandomValues(b);
		return b[0];
	}
	function hashSeed(seed, str) {
		let h = seed ^ 2166136261;
		for (let i = 0; i < str.length; i++) {
			h ^= str.charCodeAt(i);
			h = Math.imul(h, 16777619);
		}
		return h >>> 0;
	}

	/* ---------- Papa Parse laden ---------- */
	await new Promise((ok, err) => {
		const s = document.createElement('script');
		s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
		s.onload = ok;
		s.onerror = err;
		document.head.appendChild(s);
	});

	/* ---------- Daten laden ---------- */
	async function loadQuestions() {
		const res = await fetch(CSV_URL, { cache: 'no-store' });
		const text = await res.text();
		const { data } = Papa.parse(text, { header: true, skipEmptyLines: true });
		const map = new Map();
		for (const row of data) {
			const qid = String(row.question_id).trim();
			const qtext = row.question_text;
			const oid = String(row.option_id).trim();
			const olab = row.option_label;
			if (!map.has(qid)) map.set(qid, { id: qid, text: qtext, options: [] });
			map.get(qid).options.push({ id: oid, label: olab });
		}
		return [...map.values()];
	}

	/* ---------- Zustand ---------- */
	const state = {
		seed: seedFromCrypto(),
		email: '',
		consent: false,
		questions: [],
		qOrder: [],
		idx: 0,
		answers: {}
	};

	/* ---------- UI-Refs ---------- */
	const pageEmail = document.getElementById('page-email');
	const pageQ = document.getElementById('page-q');
	const pageFinish = document.getElementById('page-finish');
	const qTitle = document.getElementById('q-title');
	const ranklist = document.getElementById('ranklist');
	const progress = document.getElementById('progress');
	const startBtn = document.getElementById('start');
	const consent = document.getElementById('consent');
	const email = document.getElementById('email');
	const nextBtn = document.getElementById('next');
	const prevBtn = document.getElementById('prev');
	const submitBtn = document.getElementById('submit');
	const emailMsg = document.getElementById('email-msg');
	const sendMsg = document.getElementById('send-msg');
	const summary = document.getElementById('summary');

	function show(el) {
		[pageEmail, pageQ, pageFinish].forEach((p) => p.classList.add('d-none'));
		el.classList.remove('d-none');
	}

	/* ---------- Drag & Drop ---------- */
	let dragEl = null;
	ranklist.addEventListener('dragstart', (e) => {
		if (e.target.tagName !== 'LI') return;
		dragEl = e.target;
		e.dataTransfer.effectAllowed = 'move';
		dragEl.classList.add('opacity-50');
	});
	ranklist.addEventListener('dragend', () => {
		if (dragEl) {
			dragEl.classList.remove('opacity-50');
			dragEl = null;
		}
	});
	ranklist.addEventListener('dragover', (e) => {
		if (!dragEl) return;
		e.preventDefault();
		const items = [...ranklist.querySelectorAll('li')];
		const after = items.find((li) => {
			const r = li.getBoundingClientRect();
			return e.clientY < r.top + r.height / 2;
		});
		if (after) ranklist.insertBefore(dragEl, after);
		else ranklist.appendChild(dragEl);
	});

	/* ---------- Render ---------- */
	function currentQuestion() {
		const qid = state.qOrder[state.idx];
		return state.questions.find((q) => q.id === qid);
	}

	function renderQuestion() {
		const q = currentQuestion();
		qTitle.textContent = q.text;
		progress.textContent = `Frage ${state.idx + 1} von ${state.qOrder.length}`;
		ranklist.innerHTML = '';
		// geshuffelte Startreihenfolge, stabil pro Frage
		const R = rng(hashSeed(state.seed, q.id));
		const opts = shuffle(q.options, R);
		const startList = state.answers[q.id]?.map((id) => q.options.find((x) => x.id === id)) ?? opts;
		for (const o of startList) {
			const li = document.createElement('li');
			li.className = 'list-group-item';
			li.textContent = o.label;
			li.dataset.choice = o.id;
			li.setAttribute('draggable', 'true');
			ranklist.appendChild(li);
		}
		prevBtn.classList.toggle('disabled', state.idx === 0);
		nextBtn.textContent = state.idx === state.qOrder.length - 1 ? 'Weiter zur Abgabe' : 'Weiter';
	}

	/* ---------- Serialisierung ---------- */
	function captureCurrent() {
		const q = currentQuestion();
		const order = [...ranklist.querySelectorAll('li')].map((li) => li.dataset.choice);
		if (order.length !== q.options.length) return false;
		state.answers[q.id] = order;
		return true;
	}

	/* ---------- Ablauf ---------- */
	startBtn.addEventListener('click', async () => {
		state.email = email.value.trim();
		state.consent = consent.checked;
		if (!state.consent) {
			emailMsg.textContent = 'Bitte Zustimmung erteilen.';
			return;
		}
		if (state.email && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(state.email)) {
			emailMsg.textContent = 'Bitte gültige E-Mail oder leer lassen.';
			return;
		}

		state.questions = await loadQuestions();
		const R = rng(state.seed);
		state.qOrder = shuffle(
			state.questions.map((q) => q.id),
			R
		);

		show(pageQ);
		renderQuestion();
		emailMsg.textContent = '';
	});

	nextBtn.addEventListener('click', () => {
		if (!captureCurrent()) {
			alert('Bitte alle Optionen ordnen.');
			return;
		}
		if (state.idx < state.qOrder.length - 1) {
			state.idx += 1;
			renderQuestion();
		} else {
			summary.textContent = `Bereit zum Senden. ${state.qOrder.length} Fragen beantwortet.`;
			show(pageFinish);
		}
	});

	prevBtn.addEventListener('click', () => {
		if (state.idx > 0) {
			state.idx -= 1;
			renderQuestion();
		}
	});

	submitBtn.addEventListener('click', async () => {
		if (!captureCurrent()) {
			alert('Bitte Optionen ordnen.');
			return;
		}
		const payload = {
			seed: String(state.seed),
			email: state.email || null,
			q_order: state.qOrder,
			answers: state.answers
		};
		sendMsg.textContent = 'Sende…';
		try {
			const r = await fetch(FORMSPREE_ENDPOINT, {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});
			if (r.ok) {
				sendMsg.textContent = 'Danke. Antworten gespeichert.';
				submitBtn.disabled = true;
			} else {
				const t = await r.text();
				sendMsg.textContent = 'Fehler beim Senden: ' + t.slice(0, 200);
			}
		} catch (err) {
			sendMsg.textContent = 'Netzwerkfehler: ' + err;
		}
	});
</script>
