<script type="module">
	/* ---------- Configuration ---------- */
	const CSV_URL = 'questions.csv';
	const FORMSPREE_ENDPOINT = 'https://formspree.io/f/xrbyjror';

	/* ---------- Util ---------- */
	function rng(seed) {
		let t = seed >>> 0;
		return () => {
			t |= 0;
			t = (t + 0x6d2b79f5) | 0;
			let r = Math.imul(t ^ (t >>> 15), 1 | t);
			r ^= r + Math.imul(r ^ (r >>> 7), 61 | r);
			return ((r ^ (r >>> 14)) >>> 0) / 4294967296;
		};
	}
	function shuffle(a, rand = Math.random) {
		const x = a.slice();
		for (let i = x.length - 1; i > 0; i--) {
			const j = Math.floor(rand() * (i + 1));
			[x[i], x[j]] = [x[j], x[i]];
		}
		return x;
	}
	function seedFromCrypto() {
		const b = new Uint32Array(1);
		crypto.getRandomValues(b);
		return b[0];
	}

	/* ---------- Load Papa Parse ---------- */
	await new Promise((ok, err) => {
		const s = document.createElement('script');
		s.src = 'https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js';
		s.onload = ok;
		s.onerror = err;
		document.head.appendChild(s);
	});

	/* ---------- Load two-option questions (new schema) ---------- */
	async function loadQuestions() {
		const res = await fetch(CSV_URL, { cache: 'no-store' });
		const text = await res.text();
		const { data } = Papa.parse(text, { header: true, skipEmptyLines: true });
		const questions = [];
		for (const row of data) {
			if (!row || !row.uniqueid) continue;
			const q = {
				id: String(row.uniqueid).trim(),
				mediaId: String(row['media.id'] || '').trim(),
				title: String(row['media.title'] || '').trim(),
				img: String(row['rel_path'] || '').trim(),
				options: [
					{ id: String(row.model_1 || '').trim(), label: String(row.model_1_content || '').trim() },
					{ id: String(row.model_2 || '').trim(), label: String(row.model_2_content || '').trim() }
				]
			};
			if (q.options[0].label && q.options[1].label) questions.push(q);
		}
		return questions;
	}

	/* ---------- State ---------- */
	const state = {
		seed: seedFromCrypto(),
		email: '',
		consent: false,
		questions: [],
		qOrder: [],
		idx: 0,
		// answers: array of { objectid, winner, loser }
		answers: []
	};

	/* ---------- UI refs ---------- */
	const pageIntro = document.getElementById('page-intro');
	const pageQ = document.getElementById('page-q');
	const pageFinish = document.getElementById('page-finish');

	const startBtn = document.getElementById('start');
	const consent = document.getElementById('consent');
	const email = document.getElementById('email');
	const emailMsg = document.getElementById('email-msg');

	const progress = document.getElementById('progress');
	const imgEl = document.getElementById('q-image');
	const captionEl = document.getElementById('q-caption');
	const instrEl = document.getElementById('q-instr');

	const prevBtn = document.getElementById('prev');
	const nextBtn = document.getElementById('next');
	const leftBtn = document.getElementById('left');
	const rightBtn = document.getElementById('right');

	const submitBtn = document.getElementById('submit');
	const sendMsg = document.getElementById('send-msg');
	const summary = document.getElementById('summary');

	function show(el) {
		[pageIntro, pageQ, pageFinish].forEach((p) => p.classList.add('d-none'));
		el.classList.remove('d-none');
	}

	/* ---------- Helpers ---------- */
	function currentQuestion() {
		const qid = state.qOrder[state.idx];
		return state.questions.find((q) => q.id === qid);
	}

	function renderQuestion() {
		const q = currentQuestion();
		progress.textContent = `Frage ${state.idx + 1} von ${state.qOrder.length}`;
		imgEl.src = q.img;
		imgEl.alt = q.title || 'Abbildung';
		captionEl.innerHTML = `<strong>${q.title || 'Ohne Titel'}</strong> <span class="text-muted">(Titel: Stadt.Geschichte.Basel)</span>`;
		instrEl.textContent =
			'Wähle die passendere Beschreibung. Beide Beschreibungen wurden automatisch generiert und können Fehler enthalten.';
		const [a, b] = q.options; // Reihenfolge aus CSV
		leftBtn.textContent = a.label;
		rightBtn.textContent = b.label;
		leftBtn.dataset.choice = a.id; // Modell-ID
		rightBtn.dataset.choice = b.id; // Modell-ID
		leftBtn.dataset.text = a.label; // Text
		rightBtn.dataset.text = b.label; // Text
		prevBtn.classList.toggle('disabled', state.idx === 0);
		nextBtn.textContent = state.idx === state.qOrder.length - 1 ? 'Zur Auswertung' : 'Weiter';
	}

	function recordAnswer(choiceSide) {
		const q = currentQuestion();
		const pick = choiceSide === 'left' ? leftBtn : rightBtn;
		const loser = choiceSide === 'left' ? rightBtn : leftBtn;
		state.answers.push({
			uniqueid: q.id,
			'media.id': q.mediaId,
			leftBtn: leftBtn.dataset.choice,
			rightBtn: rightBtn.dataset.choice,
			winner: pick.dataset.choice,
			loser: loser.dataset.choice
		});
	}

	/* ---------- Keyboard shortcuts ---------- */
	function onKey(e) {
		if (pageQ.classList.contains('d-none')) return;
		if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a' || e.key === '1') {
			leftBtn.click();
		} else if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'l' || e.key === '2') {
			rightBtn.click();
		}
	}
	addEventListener('keydown', onKey);

	/* ---------- Flow ---------- */
	startBtn.addEventListener('click', async () => {
		state.email = email.value.trim();
		state.consent = consent.checked;

		if (!state.consent) {
			emailMsg.textContent = 'Bitte Einwilligung erteilen.';
			return;
		}
		if (!state.email) {
			emailMsg.textContent = 'E-Mail ist erforderlich.';
			return;
		}
		if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(state.email)) {
			emailMsg.textContent = 'Ungültige E-Mail.';
			return;
		}

		state.questions = await loadQuestions();
		state.qOrder = shuffle(
			state.questions.map((q) => q.id),
			rng(state.seed)
		); // nur Fragen shufflen
		state.idx = 0;
		state.answers = [];
		show(pageQ);
		renderQuestion();
		emailMsg.textContent = '';
	});

	[leftBtn, rightBtn].forEach((btn) => {
		btn.addEventListener('click', () => {
			recordAnswer(btn === leftBtn ? 'left' : 'right');
			if (state.idx < state.qOrder.length - 1) {
				state.idx++;
				renderQuestion();
			} else {
				summary.textContent = `Bereit zum Senden. ${state.answers.length} Antworten erfasst.`;
				show(pageFinish);
			}
		});
	});

	nextBtn.addEventListener('click', () => {
		// Navigiert ohne Auswahl nicht weiter
		alert('Bitte eine Option wählen (Tasten: ←/A/1 oder →/L/2).');
	});

	prevBtn.addEventListener('click', () => {
		if (state.idx > 0) {
			// vorherige Antwort entfernen, um Konsistenz zu wahren
			state.answers.pop();
			state.idx--;
			renderQuestion();
		}
	});

	submitBtn.addEventListener('click', async () => {
		if (state.answers.length !== state.qOrder.length) {
			alert('Es fehlen Antworten.');
			return;
		}
		const payload = {
			seed: String(state.seed),
			email: state.email,
			// kompakte Struktur für Analyse:
			// [{objectid, winner, loser}, ...]
			answers: state.answers
		};
		sendMsg.textContent = 'Senden…';
		try {
			const r = await fetch(FORMSPREE_ENDPOINT, {
				method: 'POST',
				headers: { Accept: 'application/json', 'Content-Type': 'application/json' },
				body: JSON.stringify(payload)
			});
			sendMsg.textContent = r.ok ? 'Danke. Antworten gespeichert.' : 'Fehler beim Senden.';
			if (r.ok) submitBtn.disabled = true;
		} catch (err) {
			sendMsg.textContent = 'Netzwerkfehler: ' + err;
		}
	});
</script>

<div class="container my-4" id="app">
	<!-- Seite 1: Einleitung & Kontakt -->
	<div class="card" id="page-intro">
		<div class="card-body">
			<h3 class="card-title mb-3">Studie: Vergleich von Alternativtexten</h3>
			<p class="text-muted">
				Auf jeder Seite sehen Sie ein Sammlungsbild und zwei kurze Beschreibungen. Wählen Sie die
				passendere Beschreibung so schnell wie möglich. Beide Beschreibungen wurden automatisch
				generiert und können Fehler enthalten.
			</p>
			<div class="mb-2">
				<strong>Bewertungsregeln nach WCAG-Intention:</strong>
				<ul class="small mb-2">
					<li>Kerninhalt des Bildes knapp und sachlich wiedergeben (ca. 90–180 Zeichen).</li>
					<li>Kein „Bild von…“, keine redundanten Metadaten, keine Wertungen.</li>
					<li>Wesentliche visuelle Merkmale priorisieren; Kontext nur bei Verständnishilfe.</li>
				</ul>
				<p class="small text-muted mb-3">Tastatur: ←/A/1 = links, →/L/2 = rechts.</p>
			</div>

			<div class="mb-3">
				<label for="email" class="form-label">E-Mail <span class="text-danger">*</span></label>
				<input id="email" type="email" class="form-control" placeholder="name@example.org" required />
			</div>

			<div class="form-check mb-3">
				<input class="form-check-input" type="checkbox" id="consent" />
				<label class="form-check-label" for="consent">
					Ich willige in die Verarbeitung meiner Daten für diese Studie ein.
				</label>
			</div>

			<button id="start" class="btn btn-primary">Start</button>
			<p id="email-msg" class="text-muted mt-2"></p>
		</div>
	</div>

	<!-- Seite 2: Frage -->
	<div class="card d-none" id="page-q">
		<div class="card-body">
			<div id="progress" class="text-muted mb-2"></div>

			<figure class="figure mb-3 text-center">
				<img id="q-image" class="q-image img-fluid" alt="" />
				<figcaption id="q-caption" class="small text-muted mt-1"></figcaption>
			</figure>

			<p id="q-instr" class="text-muted mb-3"></p>

			<div id="pair" class="d-flex flex-column flex-md-row gap-3 mb-3">
				<button id="left" class="btn btn-outline-secondary flex-fill"></button>
				<button id="right" class="btn btn-outline-secondary flex-fill"></button>
			</div>

			<div class="d-flex gap-2">
				<button id="prev" class="btn btn-outline-secondary">Zurück</button>
				<button id="next" class="btn btn-primary">Weiter</button>
			</div>
		</div>
	</div>

	<!-- Seite 3: Abschluss -->
	<div class="card d-none" id="page-finish">
		<div class="card-body">
			<h3 class="card-title mb-3">Abschluss</h3>
			<p class="text-muted" id="summary">Übermittlung…</p>
			<button id="submit" class="btn btn-primary">Antworten senden</button>
			<div id="send-msg" class="text-muted mt-2"></div>
		</div>
	</div>
</div>

<style>
	.q-image {
		max-height: 50vh;
		width: auto;
		object-fit: contain;
	}
</style>